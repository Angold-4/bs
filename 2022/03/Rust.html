<!DOCTYPE html>
<html lang="en"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Angold-4 Organization</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="../../../images/favicon.png" rel="icon">

<link rel="canonical" href=".">
        <meta name="author" content="Angold Wang" />

    <meta property="og:site_name" content="Angold-4" />
<!--     <meta property="og:type" content="article"/> -->
    <meta property="og:title" content="Angold-4 Organization"/>
    <meta property="og:url" content="."/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="../../../theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="../../../theme/css/font-awesome.min.css" rel="stylesheet">
<!--     <link href="https://cdnjs.cloudflare.com/ajax/libs/typicons/2.0.9/typicons.min.css" rel="stylesheet"> -->

    <link href="../../../theme/css/pygments/monokai.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../theme/css/style.css" type="text/css"/>

</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!-- <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script> -->

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://angold4.org" class="navbar-brand">
<img src="../../../images/logo.png" width="32"/> Angold4            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
			    <li><a href="../../../about.html">About</a>
                            <li><a href="../../../blogs.html">Blogs</a>
                            <li><a href="../../../projects.html">Projects</a>

	    </ul>
            <ul class="nav navbar-nav navbar-right">
                <li> <a title="Youtube" href="https://www.youtube.com/channel/UC3ZAjh2LHhm-FrgxgBtgMzQ" target="_new"><i class="fa fa-youtube"></i> Youtube</a>
		</li>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->


<div class="container">
    <div class="row">
        <div class="col-lg-12">
	<section id="content" class="body">



<h1>The Rust Programming Language</h1>
<h5>Angold Wang | 2022-03-24</h5>
<h2>1. Why Rust?</h2>
<h4>&quot;Safe System Performance Programming&quot;</h4>
<ul>
<li><strong>System Programming Language:</strong> <em>C, C++</em>.</li>
<li><strong>Safe Programming Language:</strong> <em>ML, Haskell, Java</em></li>
</ul>
<p><strong>Mozilla trying to blend the best of both of these languages</strong>.</p>
<h4>Why is Mozilla interested in creating a new programming language?</h4>
<ul>
<li>Mozilla is the organization that created the Firefox web browser, current written in <em>C++</em>.</li>
<li><strong>Web browsers need a high degree of control over the machine</strong>.
<ul>
<li>Doing very complex tasks very quickly (all these tabs running simultaneously)</li>
</ul>
</li>
<li><strong>Web browsers need safety</strong>
<ul>
<li>Running untrusted code, which is been downloaded from internet.</li>
</ul>
</li>
<li><strong>Languages like <em>C/C++</em> that give you the kind of control you need in order to get the performance, but also leave you open to all kinds of security vulnerabilities.</strong></li>
<li>Mozilla want to build the next generation web browser, which is a project called <em><a href="https://github.com/servo/servo">servo</a></em>. And they wants to do it in a new language that tries to do better at giving you both <strong>control</strong> and <strong>safety</strong> at the same time.</li>
</ul>
<h2>2. Control - Case study: Zero-Cost Abstraction in C / C++</h2>
<p>C and C++ is sort of the best existing language in this respect (control).</p>
<h3>i. Memory Allocation</h3>
<p><img src="Sources/memlayout.png" alt="memlayout"></p>
<p>Basically, there are <strong>four</strong> places in Memory for C/C++ program to store data.</p>
<h4>1. Stack</h4>
<p><strong>Most of the temporary variables created at runtime are stored in the stack. They are created (push) when the corresponding procedure is called and destroyed (pop) when returns.</strong></p>
<p>Consider the following C code snippet:</p>
<pre><code class="language-c">char s[] = &quot;abc&quot;; // {'a', 'b', 'c', 'd', '\n'}
char t[3] = &quot;def&quot;;

printf(&quot;s: %s\n&quot;, s);
printf(&quot;t: %s\n&quot;, t);
</code></pre>
<p>The output of this process looks strange:</p>
<pre><code>s: abc
t: defabc
</code></pre>
<p>After check the generated assembly code in <strong><a href="./src/char.s">char.s</a></strong>, It is easy to figure out why <strong><code>t</code></strong> becomes <strong><code>defabc</code></strong>.</p>
<p><strong>Since <code>printf</code> only stops looking for the next byte when encounters <code>\0</code> (terminator).</strong> If we do not define the variable with the correct format and size, because these temp data are stored in the stack, sometimes it will cause some unexpected errors.</p>
<p><img src="Sources/stack.png" alt="stack"></p>
<h4>2. Text</h4>
<p><strong>The Text segment has <code>e</code> bit enabled, the compiler generate program instructions in this segment. And this segment also hardcodes all &quot;strings&quot; that was defined inside the function.</strong></p>
<pre><code class="language-asm">	.section	__TEXT,__cstring,cstring_literals
L___const.main.s:                       ## @__const.main.s
	.asciz	&quot;abc&quot;

	.section	__TEXT,__const
l___const.main.t:                       ## @__const.main.t
	.ascii	&quot;def&quot;
</code></pre>
<h4>3. Heap</h4>
<p><strong>In C, the <code>malloc()</code> function will allocate a memory in Heap, and then return the begin address of that chunk of new memory.</strong></p>
<pre><code class="language-c">char *p = malloc(6*sizeof(char));
strcpy(p, &quot;strcpy&quot;);
printf(&quot;p: %s\n&quot;, p); // strcpy
</code></pre>
<p><img src="Sources/heap.png" alt="heap"></p>
<h4>4. Data</h4>
<p><strong>The Data segment contains global data. Which can be accessed from all functions in the current program.</strong></p>
<pre><code class="language-asm">	.section	__DATA,__data
	.globl	_data                           ## @data
	.p2align	2
_data:
	.long	12345                           ## 0x3039

</code></pre>
<h3>ii. Calling Conventions</h3>
<p><strong>The calling conventions describes the interface of the called code.</strong> Which makes the caller code can find what they wants (arguments, return address, fp ,etc.)</p>
<p><img src="Sources/CC.png" alt="CC"></p>
<p>There are two kinds of the registers in <strong>Calling Conventions:</strong> caller and callee saved.</p>
<h4>Caller-Saved Registers</h4>
<p><strong>Not preserved across the call.</strong> These are scratch registers - the callee is allowed to scribble over them. <strong>So if the caller cares about their contents, the caller must save them into stack before make the call.</strong></p>
<h4>Callee-Saved Registers</h4>
<p><strong>Preserved across the call.</strong> If the callee uses them, then the callee must restore the original values before returning.</p>
<h4>Usage of <code>%fp / %rbp</code></h4>
<p>Except for addressing variables in stack, the frame pointer (also called base pointer) are also used in <strong>Back Trace.</strong> Which can print the <strong>calling stack</strong> during the fn calling conventions</p>
<pre><code class="language-c">void
backtrace(void) {
    uint64 cur_fp = r_fp();

    while (cur_fp != PGROUNDDOWN(cur_fp)) {   // Page top
	printf(&quot;%p\n&quot;, *(uint64 *)(cur_fp - 8));  // the return address
	cur_fp = *(uint64 *)(cur_fp - 16);        // next frame begin
    }
}

</code></pre>
<h3>iii. Zero-Cost Abstraction</h3>
<p>When we say <strong>&quot;Control&quot;</strong> in programming language, it usually means <strong>&quot;How much control we can get over the machine?&quot;</strong></p>
<p>For example, like what I mentioned earlier. If you declare a <code>vector</code> in C++ and you've read the <code>STL</code> code. You'll know exactly how that is going to be laid out in terms of the memory.</p>
<pre><code class="language-c">vector&lt;int&gt; vec;
auto&amp; elem = vec[0];
</code></pre>
<p>In particular, in this code snipper. There are some field of the vector, including a pointer to the actuall data in the heap and some metadata about it, that all live on the stack. And you can have a lot of controls over the layout if you want.</p>
<p><img src="Sources/stlvec.png" alt="stlvec"></p>
<p>One of the principles that you get out of C++ is something often called <strong>&quot;Zero-cost abstraction&quot;.</strong> Which means you can build libraries like <code>vector</code> or <code>string</code> that are reasonably convinence to use (they give you nice abstraction). <strong>But if you compile it down. It is nothing different than you could have written by hand in assembly.</strong></p>
<h4>You're not giving up any performance in doing this abstraction</h4>
<h2>3. Design Patten</h2>
<p>Here I'll show some design choices/pattens in Rust: Based on the book 《The Rust Programming Language》</p>
<h3>0. Compiler Errors</h3>
<p>In Rust, compiler errors can be frustrating and occur frequently, but really they only mean your program isn’t safely doing what you want it to do yet; they do not mean that you’re not a good programmer! Experienced Rustaceans still get compiler errors.</p>
<h3>1. Mutability</h3>
<p><strong>By default variables are immutable.</strong> It’s important that we get compile-time errors when we attempt to change a value that’s designated as immutable because this very situation can lead to bugs.</p>
<p>If one part of our code operates on the assumption that a value will never change and another part of our code changes that value, it’s possible that the first part of the code won’t do what it was designed to do. The cause of this kind of bug can be difficult to track down after the fact, <strong>especially when the second piece of code changes the value only sometimes.</strong></p>
<h4>Shadowing</h4>
<pre><code class="language-rust">fn main() {
    let x = 5;

    let x = x + 1;

    {
        let x = x * 2;
        println!(&quot;The value of x in the inner scope is: {x}&quot;);
    }

    println!(&quot;The value of x is: {x}&quot;);
}
</code></pre>
<p>The first variable <code>x</code> is <strong>shadowed</strong> by the second, means that the second variable is what the compiler will see when you use the name of the variable in the inner scope. As a concequence:</p>
<ol>
<li>We do not need to make a new temporary variable name (e.g., y) to use, we can reuse the same name efficiently.</li>
<li>By using <code>let</code>, we can perform a few operations on a value but have the variable immutable after those ops have been completed.</li>
</ol>
<pre><code>$ cargo run
   Compiling variables v0.1.0 (file:///projects/variables)
    Finished dev [unoptimized + debuginfo] target(s) in 0.31s
     Running `target/debug/variables`
The value of x in the inner scope is: 12
The value of x is: 6
</code></pre>
<h3>2. Statements and Expressions</h3>
<ul>
<li><strong>Statements</strong> are instructions that perform some action and do not return a value.</li>
<li><strong>Expressions</strong> evaluate to a resulting value.</li>
</ul>
<p>Expressions evaluate to a value and make up most of the rest of the code that you’ll write in Rust.</p>
<pre><code class="language-rust">fn main() {
    let y = {
        let x = 3;
        x + 1
    };

    println!(&quot;The value of y is: {y}&quot;);
}
</code></pre>
<p>The block is an expression, in this case, evaluates to <code>4</code>. That value gets bound to <code>y</code> as part of the let statement. Note that the <code>x + 1</code> line doesn’t have a semicolon at the end, unlike most of the lines you’ve seen so far. <strong>Expressions do not include ending semicolons</strong>. If you add a semicolon to the end of an expression, you turn it into a statement, and it will then not return a value.</p>
<p>In Rust, the return value of the function is synonymous with the value of the final expression in the block of the body of a function.</p>
<h3>3. Ownership</h3>
<p>Ownership is a set of rules that governs how a Rust program manages memory. All programs have to manage the way they use a computer’s memory while running.</p>
<p>In general, there are three ways for programming language to free the unused memory:</p>
<ol>
<li><strong>Explicitly allocate and free the memory.</strong> (e.g,. C, C++)</li>
<li><strong>Using Garbage Collector that regularly looks for no-longer used memory as the program runs</strong> (e.g,. Java, Go)</li>
<li><strong>Memory is managed through a system of ownership with a set of rules that the compiler checks. If all rules were followed, the code will be compiled successfully, and the compiler will help you do the deallocation automatically</strong> (e.g,. Rust)</li>
</ol>
<p>Genearally, In the first approach, it’s our responsibility to identify when memory is no longer being used and call code to explicitly free it, just as we did to request it. Doing this correctly has historically been a difficult programming problem. <strong>If we forget, we’ll waste memory. If we do it too early, we’ll have an invalid variable. If we do it twice, that’s a bug too. We need to pair exactly one allocate with exactly one free.</strong></p>
<p>In the second approach, we do not need to think about the memory stuff, just keep creating the variables in the heap, and the Garbage Collector (GC) will help us to cleans up the memory that isn't being used anymore. The GC usually runs aside our program, and will slow it down due to the limited computer resources.</p>
<p>In Rust, the third approach, if we obey the rules of ownership and make the program compiled, <strong>none of the features of ownership will slow down your program while it’s running, and you won't gain any both potential bugs and unreleased unused memory.</strong></p>
	</section>
	</div>
    </div>

<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
this.page.url = "https://angold4.org/bs/2022/03/Rust.html"
this.page.identifier = "bs/2022/03/Rust.html"

    };
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://angold.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>
<footer>
   <div class="well well-lg" id="footer-well">
      <div class="container">


      <div class="row">
         <div class="col-xs-6">
            <a href="https://angold4.org" title="Angold-4 Organization" class="image-link"><img src="../../../images/logo.png" class="cmudb-logo" /></a>
         </div>
         <div class="col-xs-6">
            <p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p>
        </div>
      </div>
   </div>
   </div>
</footer>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="../../../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="../../../theme/js/respond.min.js"></script>

<!-- Fix scrolling issues to internal HREFs that get positioned behind navbar -->
<!-- http://stackoverflow.com/questions/10732690/offsetting-an-html-anchor-to-adjust-for-fixed-header -->
<script src="../../../theme/js/href_scroll.js"></script>

<!-- You know what this is and you know what he did to me... -->
<script src="../../../theme/js/tim-kraska-betrayed-me.js"></script>
</body>
</html>

